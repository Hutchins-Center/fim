---
title: 'Fiscal Impact Update'
subtitle: 'Changes in contributions relative to previous update'
author: ' Manuel Alcala Kovalski, Sophia Campbell, and Tyler Powell'
date: "`r Sys.Date()`"
header-includes:
   - \usepackage[default]{sourcesanspro}
   - \usepackage[T1]{fontenc}
mainfont: SourceSansPro
output:
  html_document:
    toc: true # table of content true
    toc_float: true
    toc_depth: 2
    number_sections: false 
    theme: united
    highlight: zenburn 
    hig.retina: 3
    self_contained: yes
    css: [style.css]
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  echo = FALSE,
  fig.align = 'center',
  warning = FALSE,
  message = FALSE,
  cache = FALSE
)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r source}
librarian::shelf(
  'tidyverse',
  'purrr',
  'tsibble',
  'lubridate',
  'glue',
  'ggiraph',
  'plotly'
)
comparison_plot <- function(.data, variable){
  
  
  plot <- .data %>% 
    filter(variable == {{ variable }}) %>% 
    ggplot(aes(x = date,  y =  value, fill = source)) +
    #geom_col(position=position_dodge2(reverse = TRUE)) +
    geom_col(position=position_dodge2(reverse = TRUE)) +
    labs(title = glue::glue("{snakecase::to_title_case(variable)}"),
         x = NULL,
         y = NULL) +
    ggthemes::theme_hc() +
    gghutchins::scale_fill_hutchins(
      name = "",
      labels = c('Updated', 'Previous'),
      pal = 'qual',
      rev = FALSE
    ) +
    scale_x_yearquarter(breaks = waiver(),
                        date_breaks = '3 months',
                        date_labels = "Q%q") +
    facet_grid( ~ year(date),
                space = "free_x",
                scales = "free_x",
                switch = "x")  +
    theme(legend.position = 'top') +
    guides(fill = guide_legend(reverse = TRUE)) 
  
  
  variable_name <- rlang::as_name(rlang::ensym(variable))
  
  if(str_ends(variable_name, 'contribution')){
    plot + 
      scale_y_continuous(name = '', 
                         labels = scales::label_percent(scale = 1))
  } else {
    plot +
      scale_y_continuous(name = '', 
                         labels = scales::label_comma())
  }
  
}

```

```{r}
# 
# # Load previous months results
# previous <- 
#   readxl::read_xlsx('results/4-2021/fim-4-2021-without-errors.xlsx') %>% 
#   mutate(date = yearquarter(date)) %>% 
#   drop_na(date) %>% 
#   as_tsibble(index = date) %>% 
#   filter_index("2020 Q2" ~ "2023 Q1") 
#  
# # 
# current <- readxl::read_xlsx('results/5-2021/fim-5-2021.xlsx') %>% 
#   mutate(date = yearquarter(date)) %>% 
#   drop_na(date) %>% 
#   as_tsibble(index = date) %>% 
#   filter_index("2020 Q2" ~ "2023 Q1")
# 
# previous_long <- pivot_longer(previous, cols = where(is.numeric), values_to = 'previous')
# current_long <- pivot_longer(current, cols = where(is.numeric), values_to = 'current')
# 
# comparison <- inner_join(previous_long, 
#                          current_long,
#                          by = c('date', 'name', 'id')) %>% 
#   pivot_longer(c(previous, current),
#                names_to = 'source') %>% 
#   rename(variable = name)
# 
# comparison_nested <-
#   comparison %>% 
#   group_by(variable) %>% 
#   nest() %>% 
#   mutate(plot = map2(.x = variable,
#                      .y = data,
#                      .f = ~comparison_plot(.data = .y, 
#                                   variable = .x)))
# 
# 
# plots <- rlang::set_names(comparison_nested$plot, comparison_nested$variable)
```


```{r fiscal_impact}
plots$fiscal_impact
```


# Purchases {.tabset .tabset-pills}

## Contributions

"Within state and local government spending, the revision reflected a downward revision to structures investment, based on new March and revised January and February VPIP data. Compensation was also revised down, based on revised Bureau of Labor Statistics (BLS) Current Employment Statistics data on employment."

Therefore, our contribution for State purchases in Q1 2021 is lower.
```{r}
plots$federal_purchases_contribution
plots$state_purchases_contribution
```



## Levels 

```{r}
plots$federal_purchases
plots$state_purchases

```


# Grants {.tabset .tabset-pills}

We couldn't find documentation in the BEA on why investment grants were revised downwards. We assume it's because they're small anwyay.

## Contributions

```{r grants}
plots$consumption_grants_contribution
plots$investment_grants_contribution
plots$federal_non_health_grants_arp_contribution
```

## Levels

```{r}
plots$consumption_grants
plots$investment_grants
plots$federal_non_health_grants_arp
```

# Taxes

## Total {.tabset .tabset-pills}

### Contributions

```{r }
plots$federal_taxes_contribution
plots$state_taxes_contribution
```


## Corporate taxes {.tabset .tabset-pills}

### Contributions

```{r}
plots$federal_corporate_taxes_contribution
plots$state_corporate_taxes_contribution
```

### Levels

```{r}
plots$federal_corporate_taxes
plots$state_corporate_taxes
```

## Non-corporate taxes {.tabset .tabset-pills}

"Updates to Fourth-Quarter Wages and Salaries
In addition to presenting updated estimates for the first quarter, today's release presents revised estimates of fourth-quarter wages and salaries, personal taxes, and contributions for government social insurance based on updated data from the BLS Quarterly Census of Employment and Wages program. Wages and salaries are now estimated to have increased $360.5 billion in the fourth quarter of 2020, an upward revision of $157.8 billion. The revision to fourth-quarter wages and salaries resulted in a revision to GDI; real GDI increased 19.4 percent (annual rate) in the fourth quarter, an upward revision of 3.7 percentage points from the previously published estimate."

Our forecast is taking these revisions until the end of the forecast period. So these revisions lead to lower contributions than last time in the forecast period.

### Contributions

```{r}
plots$federal_non_corporate_taxes_contribution
plots$state_non_corporate_taxes_contribution
```

### Levels

```{r noncorp-taxes}
plots$federal_non_corporate_taxes
plots$state_non_corporate_taxes

```

# Transfers

## Total {.tabset .tabset-pills}

### Contributions

```{r transfers}
plots$transfers_contribution
plots$federal_transfers_contribution
plots$state_transfers_contribution

```

### Levels

```{r}
# transfers_levels
# federal_transfers_levels
# state_transfers_levels
```

## Health Outlays {.tabset .tabset-pills}
State health outlays was revised up 7.1 billion from 164.14 to 171.21 billion

Federal health outlways was revised downward by 0.0

### Contributions

```{r health}
plots$health_outlays_contribution
plots$federal_health_outlays_contribution
plots$state_health_outlays_contribution
```

### Levels

```{r}
plots$health_outlays
plots$federal_health_outlays
plots$state_health_outlays
```

## Subsidies {.tabset .tabset-pills}

### Contributions

```{r subsidies}
plots$subsidies_contribution

```

### Levels

```{r}

plots$subsidies
```

## Unemployment Insurance {.tabset .tabset-pills}
As of today, 24 states have decided to pull out of the federal unemployment insurance expansion. Therefore, we should revise our forecast for federal ui downwards. 

Also, the federal ui program ends on September 6th, 2021 but we have it ending in Q2 2021. 

Revise Q3 2021 to be 350 instead of 425

### Contributions

```{r unemployment insurance}
plots$ui_contribution
plots$federal_ui_contribution
plots$state_ui_contribution
```

### Levels

```{r}

plots$ui
plots$federal_ui
plots$state_ui
```

## Rebate Checks {.tabset .tabset-pills}

### Contribution

```{r}
plots$rebate_checks_contribution
plots$rebate_checks_arp_contribution
```

### Level

```{r}
plots$rebate_checks
plots$rebate_checks_arp
```

## Social Benefits Remainder {.tabset .tabset-pills}

Level and impact of social benefits net of health outlays, rebate checks, and unemployment insurance.

The social benefits remainder came in 3.6 billion lower than we had last time. Almost half of this is due to Federal UI which came in 1.63 billion lower.

### Contribution
```{r}
plots$federal_social_benefits_contribution
plots$state_social_benefits_contribution
```

### Level
```{r}

plots$federal_social_benefits
plots$state_social_benefits
```

```{r}
plots$federal_non_corporate_taxes_contribution
```

Look at PPP with subsidies mpc

Shave down arp mpc for rebate checks. Put money from first quartre into second  (0.12, .12 and difference at the end)

