---
title: 'Fiscal Impact Update'
subtitle: 'Q3 2021 Advanced Estimate'
author: ' Manuel Alcala Kovalski'
date: "`r Sys.Date()`"
header-includes:
   - \usepackage[default]{sourcesanspro}
   - \usepackage[T1]{fontenc}
mainfont: SourceSansPro
output:
  html_document:
    toc: true # table of content true
    toc_float: true
    toc_depth: 2
    number_sections: false 
    theme: united
    highlight: zenburn 
    hig.retina: 3
    self_contained: yes
    css: [style.css]
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  echo = FALSE,
  fig.align = 'center',
  warning = FALSE,
  message = FALSE,
  cache = FALSE 
)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r source, include=FALSE, eval=FALSE}
# 
# devtools::load_all()
# librarian::shelf(
#   'tidyverse',
#   'purrr',
#   'tsibble',
#   'lubridate',
#   'glue',
#   'magrittr'
#   
# )
# comparison_plot <- function(.data, variable){
#   plot <- .data %>% 
#     filter(variable == {{ variable }}) %>% 
#     ggplot(aes(x = date,  y =  value, fill = source)) +
#     #geom_col(position=position_dodge2(reverse = TRUE)) +
#     geom_col(position=position_dodge2(reverse = TRUE)) +
#     labs(title = glue::glue("{snakecase::to_title_case(variable)}"),
#          x = NULL,
#          y = NULL) +
#     ggthemes::theme_hc() +
#     gghutchins::scale_fill_hutchins(
#       name = "",
#       labels = c('Updated', 'Previous'),
#       pal = 'qual',
#       rev = FALSE
#     ) +
#     scale_x_yearquarter(breaks = waiver(),
#                         date_breaks = '3 months',
#                         date_labels = "Q%q") +
#     facet_grid( ~ year(date),
#                 space = "free_x",
#                 scales = "free_x",
#                 switch = "x")  +
#     theme(legend.position = 'top') +
#     guides(fill = guide_legend(reverse = TRUE)) 
#   
#   
#   variable_name <- rlang::as_name(rlang::ensym(variable))
#   
#   if(str_ends(variable_name, 'contribution')){
#     plot + 
#       scale_y_continuous(name = '', 
#                          labels = scales::label_percent(scale = 1))
#   } else {
#     plot +
#       scale_y_continuous(name = '', 
#                          labels = scales::label_comma())
#   }
#   
# }

```

```{r, include=FALSE, eval=FALSE}
# 
# # Load previous months results
# previous <-
#   readxl::read_xlsx('results/06-2021/fim-06-2021.xlsx') %>%
#   mutate(date = yearquarter(date)) %>%
#   drop_na(date) %>%
#   as_tsibble(index = date) %>%
#   filter_index("2020 Q3" ~ "2023 Q2") #%>% 
#   # mutate(federal_ui = federal_ui,
#   #        federal_ui_contribution = federal_ui_contribution + federal_ui_arp_contribution) %>% 
#   # mutate(federal_ui = federal_ui + federal_ui_arp,
#   #        federal_ui_contribution = federal_ui_contribution + federal_ui_arp_contribution) %>% 
#   # mutate(federal_health_outlays= federal_health_outlays + federal_health_grants_arp,
#   #        federal_health_outlays_contribution = federal_health_outlays_contribution + federal_health_grants_arp_contribution)
# 
# 
# 
# 
# current <- readRDS('data/contributions.RDS') %>%
#   mutate(date = yearquarter(date)) %>%
#   drop_na(date) %>%
#   as_tsibble(index = date) %>%
#   filter_index("2020 Q3" ~ "2023 Q2")
# 
# previous_long <- pivot_longer(previous, cols = where(is.numeric), values_to = 'previous')
# current_long <- pivot_longer(current, cols = where(is.numeric), values_to = 'current')
# 
# comparison <- inner_join(previous_long,
#                          current_long,
#                          by = c('date', 'name', 'id')) %>%
#   pivot_longer(c(previous, current),
#                names_to = 'source') %>%
#   rename(variable = name)
# 
# comparison_nested <-
#   comparison %>%
#   group_by(variable) %>%
#   nest() %>%
#   mutate(plot = map2(.x = variable,
#                      .y = data,
#                      .f = ~comparison_plot(.data = .y,
#                                   variable = .x)))
# 
# 
# plots <- rlang::set_names(comparison_nested$plot, comparison_nested$variable)
```


```{r fiscal_impact}
plots$fiscal_impact
```

```{r}
library(gt)
revisions_tbl
summary_tbl
```


# NIPA Consistent Purchases {.tabset .tabset-pills}






## Contributions

```{r nipa_purchases}
plots$federal_purchases_contribution + labs(subtitle = "NIPA Consistent")
plots$state_purchases_contribution +  labs(subtitle = "NIPA Consistent")
```



## Levels 

```{r nipa_purchases_levels}
plots$federal_purchases  + labs(subtitle = "NIPA Consistent")
plots$state_purchases + labs(subtitle = "NIPA Consistent")

```


# Grants {.tabset .tabset-pills}
Likewise, consumption grants are higher now given that we reattributed some of the ARP grants away from federal purchases.

## Contributions

```{r grants}
plots$consumption_grants_contribution
plots$investment_grants_contribution

```

## Levels

```{r grants_levels}
plots$consumption_grants
plots$investment_grants
```

# FIM Consistent Purchases 

## Contributions

```{r fim_purchases}
plots$federal_contribution + labs(subtitle = "FIM Consistent")
plots$state_contribution  + labs(subtitle = "FIM Consistent")
```



# Taxes

## Corporate taxes {.tabset .tabset-pills}

### Contributions

```{r corp_contribution}
plots$federal_corporate_taxes_contribution
plots$state_corporate_taxes_contribution
```

### Levels

```{r corp_lvl}
plots$federal_corporate_taxes
plots$state_corporate_taxes
```

## Non-corporate taxes {.tabset .tabset-pills}


### Contributions

```{r noncorp_cont}
plots$federal_non_corporate_taxes_contribution
plots$state_non_corporate_taxes_contribution
```

### Levels

```{r noncorp_lvl}
plots$federal_non_corporate_taxes
plots$state_non_corporate_taxes

```

# Transfers

## Total 

### Contributions

```{r transfers}
plots$transfers_contribution
plots$federal_transfers_contribution
plots$state_transfers_contribution

```


## Health Outlays {.tabset .tabset-pills}


### Contributions

```{r health}

plots$federal_health_outlays_contribution
plots$state_health_outlays_contribution
```

### Levels

```{r health_lvl}

plots$federal_health_outlays
plots$state_health_outlays
```

### Components

```{r health_comp}
plots$medicaid
plots$medicaid_grants
plots$medicare
```

## Subsidies (non-ARP) {.tabset .tabset-pills}

### Contributions

```{r subsidies}
plots$subsidies_contribution

```

### Levels

```{r subsidies_lvl}

plots$subsidies
```

## Subsidies (ARP) {.tabset .tabset-pills}
ARP PPP and Provider Relief Fund


### Contribution
```{r subsidies-arp-cont}
plots$federal_aid_to_small_businesses_arp_contribution

```

### Levels

```{r subsidies-arp-level}

plots$federal_aid_to_small_businesses_arp
```

## Unemployment Insurance {.tabset .tabset-pills}

### Contributions

```{r ui_cont}
plots$federal_ui_contribution
plots$state_ui_contribution
```

### Levels

```{r ui_lvl}

plots$federal_ui
plots$state_ui
```

## Other aid to vulnerable households {.tabset .tabset-pills}

 Premium Tax Credits, Ratepayer protection, Assistance for older Americans, COBRA, Emergency Assistance
 
### Contribution
```{r vulnerable}
plots$federal_other_vulnerable_arp_contribution
```

### Level

```{r vulnerable_lvl}
plots$federal_other_vulnerable_arp
```

## Rebate Checks (1st and 2nd round){.tabset .tabset-pills}

### Contribution

```{r rebate_cont}
plots$rebate_checks_contribution

```

### Level

```{r rebate_lvl}
plots$rebate_checks

```

## Rebate Checks (ARP) {.tabset .tabset-pills}

Last time, we forgot to include the rebate checks from ARP that will go out in the next tax year.

### Contribution

```{r rebate_arp_cont}
plots$rebate_checks_arp_contribution

```

### Level

```{r rebate_arp_lvl}
plots$rebate_checks_arp

```

## Direct aid to households {.tabset .tabset-pills}

Includes Child tax credit, EITC,  Childcare for workers,  Dependent  care for families

### Contribution

```{r aid_cont}
plots$federal_other_direct_aid_arp_contribution
```

### Level

```{r aid_lvl}
plots$federal_other_direct_aid_arp
```

## Social Benefits Remainder {.tabset .tabset-pills}

Level and impact of social benefits net of health outlays, rebate checks, and unemployment insurance.

The social benefits remainder came in 3.6 billion lower than we had last time. Almost half of this is due to Federal UI which came in 1.63 billion lower.

### Contribution
```{r soc_cont}
plots$federal_social_benefits_contribution + labs(subtitle = "Remainder of social benefits")
plots$state_social_benefits_contribution+ labs(subtitle = "Remainder of social benefits")
```

### Level
```{r soc_lvl}

plots$federal_social_benefits+ labs(subtitle = "Remainder of social benefits")
plots$state_social_benefits+ labs(subtitle = "Remainder of social benefits")
```




# Deflators {.tabset .tabset-pills}

## Delta
```{r}
diff_plot
```

## Current

```{r}
cur_plot
```

## Previous
```{r}
prev_plot
```
