---
title: "NIPA Consistent Fiscal Impact Measure Walkthrough"
author: "Manuel Alcala Kovalski"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    toc: true
    highlight: vignette
    df_print: paged
toc-title: "Table of Contents"
vignette: >
  %\VignetteIndexEntry{Creating Pretty Documents from R Markdown - The Architect Theme}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  results = 'asis'
)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## **Fiscal Impact**

The FIM is defined as the actual contributions of real government purchases and real consumption to GDP less the contributions that would have prevailed if real purchases, real taxes, and real transfers were growing with potential GDP.

Define $G$ as nominal government purchases, $\pi_{G}$ as the inflation rate for government purchases, $C$ as nominal consumption, $C$ as nominal consumption, $T$ as nominal tax or transfer payments, $Y$ as nominal GDP, and $\mu$ as real potential output growth.

Then the contribution of real purchases to GDP is the growth rate of real government purchases times the share of government in GDP:

$$
\frac{G_t}{G_{t-1}} - \frac{G_{t-1}}{Y_{t-1}} \times (1 + \pi_{G} ) = \frac{G_t - G_{t-1} \times (1 + \pi_{G})}{Y_{t-1}}
$$

In order to calculate the effects of government policy on the economy, it is necessary to specify a counterfactual; in other words, we need to know what the effects of a particular set of policies are compared to some alternative.
The counterfactual assumed by the FIM is that taxes and spending rise with potential GDP---the gross domestic output that would be obtained if the economy were at full employment.

$$
\mu \frac{G_{t-1}}{Y_{t-1}}
$$

Thus, the FIM for purchases is defined as

$$
\text{FIM}_{t}^{G} = \frac{G_t - G_{t-1} * (1 + \pi_G + \mu )}{Y_{t-1}}
$$

## **How does the FIM differ from the National Income and Product Accounts?**

Each quarter, BEA measures how much federal, state, and local governments spend on goods and services and reports what contribution those expenditures made to the headline GDP number (see Table 1.1.2 in the GDP release, for example).
The FIM is related to this measure, but estimates instead the contribution that government policies are making to GDP beyond the contribution they would make if they were growing in line with the longer-run, potential path of the economy.
Therefore, the FIM can be interpreted as a measure of how expansionary or contractionary fiscal policy is relative to the potential path of the economy.

In the BEA's National Income and Product Accounts (NIPA), government spending is attributed to the level of government that spends the money rather than to the level of government that finances the spending.
To better attribute spending to the entity that made the policy decision, we reallocate to the federal government state and local spending that is financed by the federal government.Â 
In particular, we use data on the federal share of Medicaid spending to split Medicaid expenditures into federal and state expenditures and to categorize the remainder of federal grants to states (i.e., for purposes other than Medicaid) as federal purchases.

Moreover, we spread out the \$150 billion Coronavirus Relief Fund established by the CARES Act to reflect our assumptions on when state & local governments will spend these funds.

## **Data**

Most of the data are from the the BEA's [NIPA tables](https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey).
Apart from the NIPA data, we use the Congressional Budget Office's (CBO) economic and budget projections to inform our forecasts.

```{r packages}
library('rmarkdown')
library('tidyverse')
library('magrittr')
library('dplyover')
library('tidyr')
library('tsibble')
library('janitor')
library('snakecase')
library('kableExtra')
library('fim')
```

```{r load-data, include = FALSE}
to_table <- function(df) {
  df %>%
    rename_with(.fn = ~ to_title_case(.),
                .cols = where(is.numeric)) %>%
    pivot_longer(where(is.numeric), names_to = ' ') %>%
    pivot_wider(names_from = date, values_from = value)
}
nipa_projections <- readxl::read_xlsx('inst/extdata/nipa_projections.xlsx')
add_factors <- readxl::read_xlsx('inst/extdata/LSFIM_KY_v7.xlsx', 
                         sheet = 'FIM Add Factors')
```

```{r, echo = FALSE}
nipa <-
  nipa_projections %>%
  filter(date >= '2018-03-31' & date <= '2022-12-31') %>%
  left_join(add_factors %>%
              select(date, contains(c(
                'purchases', 'grants'
              )))) %>%
  mutate(across(starts_with('add'), ~ coalesce(., 0))) %>%
  transmute(
    date = date,
    gross_domestic_product = gdp,
    
    federal_purchases = gf + add_federal_purchases,
    state_purchases = gs + add_state_purchases,
    consumption_grants_gross = gfeg,
    medicaid_grants = gfeghdx,
    consumption_grants_net = add_federal_cgrants + consumption_grants_gross - medicaid_grants,
    investment_grants = gfeigx,
    
    federal_purchases_deflator_growth = q_g(jgf),
    state_purchases_deflator_growth = q_g(jgs),
    consumption_grants_net_deflator_growth = q_g(jgse),
    investment_grants_deflator_growth = q_g(jgsi),
    real_potential_gdp_growth = q_g(gdppothq),
    
    federal_purchases_growth = gf_g,
    state_purchases_growth = gs_g,
    consumption_grants_gross_growth = gfeg_g,
    medicaid_grants_growth = gfeghhx_g,
    investment_grants_growth = gfeigx_g
  ) %>%
  mutate(date  = yearquarter(date),
         across(where(is.numeric), ~ round(., digits = 2)))

paged_table(nipa %>% to_table())
```

## **BEA's Methodology**

The contribution of purchases consistent with the BEA's methodology is calculated as follows:

```{r}
nipa %<>%
  mutate(over(c('federal_purchases', 
                'state_purchases', 
                'consumption_grants_net', 
                'investment_grants'),
              
          .fn =  ~ 400 * (.("{.x}") - lag(.("{.x}")) * (1 + .("{.x}_deflator_growth"))) 
              / lag(gross_domestic_product),
              
          .names = "{x}_contribution"))
```

```{r, include = FALSE}
nipa %<>%
  mutate(
    grants_contribution = 
      consumption_grants_net_contribution + investment_grants_contribution
  )
```

```{r, echo= FALSE, results = 'asis'}
nipa %>%
                   mutate(across(where(is.numeric),
                        ~ round(., digits = 2))) %>%
  select(
    date,
    federal_purchases_contribution,
    state_purchases_contribution,
    grants_contribution
  ) %>%
    to_table() %>%
    paged_table()
```

## **Hutchins Methodology**

The FIM's contributions differ slightly because we estimate the contribution of government policies to GDP relative to the contribution they would make if they were growing at the same rate as the potential path of the economy.

```{r, linewidth=160}
  nipa %<>%
  mutate(
    over(
      c('federal_purchases', 'state_purchases', 
        'consumption_grants_net', 'investment_grants'),
      
      .fn = ~ 400 * (.("{.x}") - 
            lag(.("{.x}")) * 
            (1 + .("{.x}_deflator_growth") + real_potential_gdp_growth)) 
              / lag(gross_domestic_product),
      
      .names = "{x}_contribution")) 
```

Finally, we reallocate the contribution of federal grants to federal purchases and subtract them from the contribution of state purchases.

```{r}
nipa %<>%
  mutate(
    grants_contribution = consumption_grants_net_contribution + investment_grants_contribution,
    federal_contribution = federal_purchases_contribution + grants_contribution,
    state_contribution = state_purchases_contribution - grants_contribution
  )
```

```{r, echo = FALSE}
nipa %>%
  mutate(across(where(is.numeric), ~ round(., digits = 2))) %>%
    
  select(date, federal_contribution,
         state_contribution, grants_contribution) %>%
  to_table() %>%
  paged_table()
```
